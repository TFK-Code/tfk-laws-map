window.TfkLaws={Models:{},Collections:{},Views:{},Routers:{},init:function(){"use strict";new TfkLaws.Routers.App;Backbone.history.start()}},$(document).ready(function(){"use strict";TfkLaws.init()}),this.JST=this.JST||{},this.JST["app/scripts/templates/map.ejs"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+="<p>Your content here.</p>\n\n";return __p},TfkLaws.Views=TfkLaws.Views||{},function(){"use strict";TfkLaws.Views.Map=Backbone.View.extend({template:JST["app/scripts/templates/map.ejs"],tagName:"div",id:"",className:"",events:{},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(this.template(this.model.toJSON()))}})}(),TfkLaws.Routers=TfkLaws.Routers||{},function(){"use strict";TfkLaws.Data=[],TfkLaws.Countries=[],TfkLaws.Codes=codes,TfkLaws.Centroids=centroids,TfkLaws.DataGrouped=[],TfkLaws.Selected=!1,TfkLaws.Routers.App=Backbone.Router.extend({routes:{"":"mapPage"},mapPage:function(){$(".loading").show(),$.ajax({dataType:"json",url:"http://crossorigin.me/http://dev.tobaccocontrollaws.org/country/getCountryList/getCountryData"}).done(function(a){function b(){$(".loading").hide(),$(".search-ui").fadeIn()}function c(a,b){var c=a.properties.iso_a2,d=a.properties.admin,e=!1,f=!1,g="",h="http://dev.tobaccocontrollaws.org/",i="",j="",k="",l="";$.each(TfkLaws.Data,function(a,b){c===b.code&&(j=b.signedFCTC.split("Smoke Free Places")[0],e=!0,f=b.lawOnly,g=b.country,i=b.country.replace(/\s+/g,"-").toLowerCase(),f===!0&&(k='<a class="btn btn-default btn-sm btn-success" target="_parent" href="'+h+"litigation/advancedsearch/?country="+g+'">Litigation</a>',l='<table><tr><td class="title" colspan="3">Analysis - <a href="'+h+"legislation/country/"+g+'/sf-indoor">View summary &raquo;</a></td><tr><td><a target="_parent" href="'+h+"legislation/country/"+g+'/sf-indoor" class="icon"></a> <a target="_parent" href="'+h+"legislation/country/"+g+'/sf-indoor">Smoke Free</a></td><td><a target="_parent" href="'+h+"legislation/country/"+g+'/aps-regulated-forms" class="icon icon-advertising"></a> <a target="_parent" href="'+h+"legislation/country/"+g+'/sf-indoor">Advertising</a></td><td><a target="_parent" href="'+h+"legislation/country/"+g+'/pl-health-warnings" class="icon icon-packaging"></a> <a target="_parent" href="'+h+"legislation/country/"+g+'/sf-indoor">Packaging</a></td></tr><tr><td class="title" colspan="3">Fact sheets - <a target="_parent" href="'+h+"/legislation/factsheet/policy_status/"+i+'">Download summary &raquo;</a></td></tr><tr class="fact-sheets"><td><a target="_parent" href="'+h+"legislation/factsheet/sf/"+i+'" class="icon"><span class="pdf">pdf</span></a> <a target="_parent" href="'+h+"legislation/factsheet/sf/"+i+'">Smoke Free</a></td><td><a target="_parent" href="'+h+"legislation/factsheet/aps/"+i+'" class="icon icon-advertising"><span class="pdf">pdf</span></a> <a target="_parent" href="'+h+"legislation/factsheet/aps/"+i+'">Advertising</a></td><td><a target="_parent" href="'+h+"legislation/factsheet/pl/"+i+'" class="icon icon-packaging"><span class="pdf">pdf</span></a> <a target="_parent" href="'+h+"legislation/factsheet/pl/"+i+'">Packaging</a></td></tr></table>'))}),e===!0?b.bindPopup("<h4>"+d+"</h4><p>"+j+'</p><a class="btn btn-default btn-sm btn-success" target="_parent" href="'+h+"legislation/country/"+i+'/summary">Summary</a> <a class="btn btn-default btn-sm btn-success" target="_parent" href="'+h+"legislation/country/"+i+'/laws">Laws</a> '+k+l):b.bindPopup("<h4>"+d+'</h4><p>We do not have any tobacco control laws or litigation for this country. If you have any information on this country, please <a target="_parent" href="'+h+'contact/">contact us</a>.</p>')}function d(a){var b=a.properties.iso_a2,c="#eee",d=.3;return $.each(TfkLaws.Data,function(a,e){b===e.code&&(e.lawOnly===!0&&(c="#eee",d=1),e.lawOnly===!1&&(c="#eee",d=.5))}),{stroke:!0,weight:1.5,opacity:1,color:"#fff",fillOpacity:d,fillColor:"#ccc",title:b,"class":b}}function e(){var a=$("#search").val().toLowerCase();$(".search-results-list").empty(),$.each(TfkLaws.Data,function(b,c){c.country.toLowerCase().indexOf(a)>-1&&($(".search-results").show(),$(".search-results-list").append('<li><a class="country-search-link" href="#" data-code="'+c.code+'">'+c.country+"</li></a>")),""===a&&$(".search-results").hide()})}function f(a){TfkLaws.Countries.setStyle({color:"#fff"}),$.each(TfkLaws.Countries._layers,function(b,c){if(c.feature.properties.iso_a2===a&&(c.setStyle({color:"#333"}),c.bringToFront(),console.log(c),c._popupContent||c._popup._content)){var d="";d=c._popupContent?c._popupContent:c._popup._content,$("#info").html(d)}})}$.each(a.countries,function(a,b){"United kingdom"===b.name&&(b.name="England"),TfkLaws.Data.push({country:b.name,code:b.abbr,lawOnly:b.lawAnalysis,signedFCTC:b.signedFCTC})}),L.mapbox.accessToken="pk.eyJ1IjoiZG1jY2FyZXkiLCJhIjoiRl9FV3ZXNCJ9.l1rdsm-F9Vwzcimtf1qMHg";var g=L.mapbox.map("map",null,{worldCopyJump:!0}).setView([40,0],2);g.scrollWheelZoom.disable(),TfkLaws.Countries=omnivore.topojson("assets/countries.json").on("ready",function(a){this.eachLayer(function(a){a.setStyle(d(a.feature)),c(a.feature,a)})}).addTo(g).on("ready",b),TfkLaws.DataGrouped=_.groupBy(TfkLaws.Data,"code"),$("#tour h4").append(tour[0].title),$("#tour p").append(tour[0].body),$("#tour, #legend").fadeIn(),TfkLaws.Countries.on("click",function(a){a.layer.closePopup(),TfkLaws.Selected===!1?TfkLaws.Selected=!0:TfkLaws.Selected=!1,g.panTo(a.latlng)}),TfkLaws.Countries.on("mouseover",function(a){$("#info").fadeIn();var b=a.layer.options.title;1!=TfkLaws.Selected&&(a.layer._popup._content&&$("#info").html(a.layer._popup._content),b&&f(b),a.layer.bringToFront())}),TfkLaws.Countries.on("mouseout",function(a){1!=TfkLaws.Selected&&TfkLaws.Countries.setStyle({color:"#fff"})}),$(document).on("click",".country-search-link",function(a){a.preventDefault(),$(".search-results").hide();var b=$(a.target).data("code"),c="",d="";$.each(TfkLaws.Centroids,function(a,e){e.ISO3136===b&&(c=e.LAT,d=e.LONG)}),TfkLaws.Countries.setStyle({color:"#fff"}),$.each(TfkLaws.Countries._layers,function(a,e){e.feature.properties.iso_a2===b&&(g.setView([c,d],3),b&&f(b),e.bringToFront(),TfkLaws.Selected=!0)})}),$(document).on("click",".tour-next-btn",function(a){a.preventDefault();var b=parseFloat($("#tour").attr("data-item"))+1;b===tour.length&&(b=0);var c=tour[b].code;$("#tour h4").html(tour[b].title),$("#tour p").html(tour[b].body),g.setView([tour[b].lat,tour[b].lng],tour[b].zoom),c&&f(c),$("#tour").attr("data-item",b)}),$(document).on("click",".tour-prev-btn",function(a){a.preventDefault();var b=parseFloat($("#tour").attr("data-item"))-1;console.log(b),-1===b&&(b=tour.length-1);var c=tour[b].code;$("#tour h4").empty().append(tour[b].title),$("#tour p").empty().append(tour[b].body),g.setView([tour[b].lat,tour[b].lng],tour[b].zoom),c&&f(c),$("#tour").attr("data-item",b)}),$(document).on("click",".tour-close",function(a){a.preventDefault(),$("#tour").hide()}),$("#search").keyup(e)})}})}();